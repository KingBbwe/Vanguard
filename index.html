<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Vanguard â€“ Stock Management System</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <style>
    :root{
      --primary:#1a2a3a;--secondary:#3498db;--accent:#e74c3c;--success:#27ae60;--warning:#f39c12;
      --light:#ecf0f1;--surface:#252f3d;--surface-light:#2a3a4a;
      --text-primary:#e0e0ff;--text-secondary:#a0a0b0;--shadow:0 4px 12px rgba(0,0,0,.25);
      --radius:10px;--transition:all .3s ease;
      --hotel-color:#4F46E5;--bar-color:#DC2626;--restaurant-color:#059669;
      --kitchen-color:#D97706;--admin-color:#7C3AED;--grounds-color:#16A34A;--cultivation-color:#CA8A04;
    }
    *{margin:0;padding:0;box-sizing:border-box;font-family:'Segoe UI',Tahoma,Geneva,Verdana,sans-serif}
    body{background:linear-gradient(135deg,var(--primary),#1e3040);color:var(--text-primary);min-height:100vh}
    .hidden{display:none!important}
    /* LOGIN */
    .login-container{min-height:100vh;display:flex;align-items:center;justify-content:center;padding:1rem}
    .login-card{background:var(--surface);padding:2rem 3rem;border-radius:var(--radius);box-shadow:var(--shadow);width:100%;max-width:420px;text-align:center}
    .login-logo{display:flex;align-items:center;justify-content:center;gap:1rem;margin-bottom:2rem}
    .login-logo i{font-size:2.5rem;color:var(--secondary);background:rgba(52,152,219,.15);padding:15px;border-radius:50%}
    .login-title{font-size:2.5rem;font-weight:700;color:white}
    .login-subtitle{color:var(--gray);margin-bottom:2rem;font-size:1.1rem}
    .pin-input{display:flex;gap:1rem;justify-content:center;margin-bottom:2rem}
    .pin-digit{width:50px;height:60px;border:2px solid var(--surface-light);border-radius:var(--radius);text-align:center;font-size:2rem;font-weight:600;background:var(--primary);color:var(--text-primary);-webkit-text-security:disc}
    .pin-digit.filled{border-color:var(--success)}
    .keypad{display:grid;grid-template-columns:repeat(3,1fr);gap:1rem;margin-bottom:2rem}
    .key{background:var(--surface-light);border:1px solid transparent;padding:1.25rem;border-radius:var(--radius);font-size:1.5rem;font-weight:600;cursor:pointer;color:var(--text-primary)}
    .key:hover{background:var(--secondary);color:white;transform:translateY(-2px);box-shadow:0 4px 8px rgba(0,0,0,.3)}
    .clear-btn,.reset-btn{width:100%;padding:1rem;border:none;border-radius:var(--radius);font-weight:600;cursor:pointer;color:white;font-size:1.1rem}
    .clear-btn{background:var(--accent)}.reset-btn{background:var(--warning);font-size:.9rem;margin-top:.5rem}
    /* APP */
    #mainApp{display:flex;flex-direction:column;min-height:100vh}
    .header{background:var(--surface);color:white;padding:1rem 1.5rem;box-shadow:var(--shadow);position:sticky;top:0;z-index:100;border-bottom:1px solid rgba(255,255,255,.08)}
    .header-content{display:flex;justify-content:space-between;align-items:center;max-width:1600px;margin:0 auto}
    .logo{display:flex;align-items:center;gap:.75rem;font-size:1.5rem;font-weight:700;color:var(--secondary)}
    .user-info{display:flex;align-items:center;gap:1rem}
    .sync-status{display:flex;align-items:center;gap:.5rem;padding:.25rem .75rem;border-radius:6px;background:var(--surface-light);font-size:.875rem}
    .sync-indicator{width:8px;height:8px;border-radius:50%;background:var(--success);animation:pulse 2s infinite}
    .sync-indicator.syncing{background:var(--warning);animation:pulse 1s infinite}
    .sync-indicator.offline{background:var(--accent);animation:none}
    .logout-btn{background:var(--surface-light);border:1px solid rgba(255,255,255,.1);color:white;padding:.5rem 1rem;border-radius:var(--radius);cursor:pointer;transition:var(--transition)}
    .logout-btn:hover{background:var(--accent)}
    .sync-actions{display:flex;gap:.5rem;align-items:center}
    .sync-btn{background:var(--surface-light);border:none;color:var(--text-primary);border-radius:50%;width:32px;height:32px;display:flex;align-items:center;justify-content:center;cursor:pointer}
    .sync-btn:hover{background:var(--secondary);color:white}
    .main-content{flex:1;display:flex;max-width:1600px;margin:0 auto;width:100%;padding:1.5rem;gap:1.5rem}
    .sidebar{width:280px;background:var(--surface);border-right:1px solid rgba(255,255,255,.08);padding:1.5rem;border-radius:var(--radius);position:sticky;top:100px}
    .nav-title{font-size:.875rem;font-weight:600;color:var(--text-secondary);text-transform:uppercase;letter-spacing:.05em;margin-bottom:1rem;padding-left:1rem}
    .dept-item{display:flex;align-items:center;gap:.75rem;padding:.75rem 1rem;border-radius:var(--radius);cursor:pointer;color:var(--text-primary);margin-bottom:.5rem;border:1px solid transparent}
    .dept-item:hover{background:var(--surface-light)}.dept-item.active{background:var(--secondary);color:white;box-shadow:0 2px 4px rgba(0,0,0,.2)}
    .content-area{flex:1;overflow-y:auto}
    .card{background:var(--surface);border-radius:var(--radius);padding:1.5rem;box-shadow:var(--shadow);border:1px solid rgba(255,255,255,.08);transition:var(--transition);margin-bottom:1.5rem}
    .card:hover{transform:translateY(-3px);box-shadow:0 8px 25px rgba(0,0,0,.4)}
    .card-header{display:flex;align-items:center;justify-content:space-between;margin-bottom:1rem;padding-bottom:1rem;border-bottom:1px solid var(--surface-light)}
    .card-title{font-size:1.25rem;font-weight:600;color:var(--secondary)}
    .card-metric{font-size:2.5rem;font-weight:700;color:var(--text-primary);margin-bottom:.5rem}
    .card-subtitle{color:var(--text-secondary);font-size:.875rem}
    .dashboard-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(250px,1fr));gap:1.5rem}
    .actions-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(150px,1fr));gap:1rem}
    .action-btn{background:var(--surface-light);border:1px solid rgba(255,255,255,.1);padding:1.5rem;border-radius:var(--radius);cursor:pointer;display:flex;flex-direction:column;gap:.75rem;align-items:center;color:var(--text-primary);text-align:center}
    .action-btn:hover{background:var(--secondary);color:white;border-color:var(--secondary);transform:translateY(-3px);box-shadow:var(--shadow)}
    .form-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(250px,1fr));gap:1.5rem}
    .form-group{display:flex;flex-direction:column;gap:.5rem}
    .form-group label{font-weight:600;color:var(--text-secondary)}
    .form-group input,.form-group select{width:100%;padding:.75rem;border-radius:var(--radius);border:1px solid var(--surface-light);background:var(--primary);color:var(--text-primary);font-size:1rem}
    .form-group input:focus,.form-group select:focus{outline:none;border-color:var(--secondary)}
    .form-actions{margin-top:1.5rem;display:flex;justify-content:flex-end;gap:1rem}
    .btn{padding:.75rem 1.5rem;border-radius:var(--radius);border:none;font-weight:600;cursor:pointer;transition:var(--transition);display:inline-flex;align-items:center;gap:.5rem}
    .btn-primary{background:var(--secondary);color:white}.btn-primary:hover{background:#2980b9}
    .btn-secondary{background:var(--surface-light);color:var(--text-primary)}.btn-secondary:hover{background:var(--dark)}
    .btn-danger{background:var(--accent);color:white}.btn-danger:hover{background:#c0392b}
    .data-table{width:100%;border-collapse:collapse}.data-table th,.data-table td{padding:.75rem 1rem;text-align:left;border-bottom:1px solid var(--surface-light)}
    .data-table th{color:var(--text-secondary);text-transform:uppercase;font-size:.875rem}
    .data-table tr:hover{background:var(--surface-light)}
    .btn-icon{background:transparent;border:none;color:var(--text-secondary);cursor:pointer;padding:.25rem;border-radius:4px}
    .btn-icon:hover{color:var(--secondary);background:rgba(255,255,255,.1)}
    /* ANIMATIONS */
    @keyframes pulse{0%,100%{opacity:1}50%{opacity:.5}}@keyframes fadeIn{from{opacity:0;transform:translateY(10px)}to{opacity:1;transform:translateY(0)}}
    @keyframes spin{to{transform:rotate(360deg)}}@keyframes shake{0%,100%{transform:translateX(0)}10%,30%,50%,70%,90%{transform:translateX(-5px)}20%,40%,60%,80%{transform:translateX(5px)}}
    @media(max-width:992px){.main-content{flex-direction:column}.sidebar{width:100%;position:static;height:auto;border-right:none;margin-bottom:1.5rem}}
  </style>
</head>
<body>
<!-- ======== LOGIN ======== -->
<div id="loginScreen" class="login-container">
  <div class="login-card">
    <div class="login-logo"><i class="fas fa-boxes-stacked"></i><div><h1 class="login-title">Vanguard</h1><p class="login-subtitle">Stock Management System</p></div></div>
    <div id="loginMessage" class="message"></div>
    <div class="pin-input">
      <input type="text" inputmode="none" class="pin-digit" maxlength="1" readonly>
      <input type="text" inputmode="none" class="pin-digit" maxlength="1" readonly>
      <input type="text" inputmode="none" class="pin-digit" maxlength="1" readonly>
      <input type="text" inputmode="none" class="pin-digit" maxlength="1" readonly>
      <input type="text" inputmode="none" class="pin-digit" maxlength="1" readonly>
    </div>
    <div class="keypad">
      <button class="key" data-key="1">1</button><button class="key" data-key="2">2</button><button class="key" data-key="3">3</button>
      <button class="key" data-key="4">4</button><button class="key" data-key="5">5</button><button class="key" data-key="6">6</button>
      <button class="key" data-key="7">7</button><button class="key" data-key="8">8</button><button class="key" data-key="9">9</button>
      <button class="key" data-key="*">*</button><button class="key" data-key="0">0</button><button class="key" data-key="%">%</button>
    </div>
    <button class="clear-btn" onclick="clearPin()">Clear PIN</button>
    <button class="reset-btn" onclick="resetApp()">Reset App Data</button>
  </div>
</div>

<!-- ======== MAIN APP ======== -->
<div id="mainApp" class="hidden">
  <header class="header">
    <div class="header-content">
      <div class="logo"><i class="fas fa-boxes-stacked"></i><span>Vanguard Stock Management</span></div>
      <div class="user-info">
        <div class="sync-status"><div id="syncIndicator" class="sync-indicator"></div><span id="syncStatus">Online</span></div>
        <span id="currentUser">Welcome</span>
        <div class="sync-actions">
          <button class="sync-btn" onclick="syncData()" title="Sync Data"><i class="fas fa-sync-alt"></i></button>
          <button class="logout-btn" onclick="logout()"><i class="fas fa-sign-out-alt"></i> Logout</button>
        </div>
      </div>
    </div>
  </header>
  <div class="main-content">
    <nav class="sidebar">
      <div class="nav-title">Departments</div>
      <div class="dept-item active" data-dept="dashboard" onclick="showDashboard()"><i class="fas fa-tachometer-alt" style="color:var(--secondary)"></i><span>Dashboard</span></div>
      <div class="dept-item" data-dept="hotel" onclick="showInventory('hotel')"><i class="fas fa-hotel" style="color:var(--hotel-color)"></i><span>Hotel Ops</span></div>
      <div class="dept-item" data-dept="bar" onclick="showInventory('bar')"><i class="fas fa-martini-glass-citrus" style="color:var(--bar-color)"></i><span>Bar</span></div>
      <div class="dept-item" data-dept="restaurant" onclick="showInventory('restaurant')"><i class="fas fa-utensils" style="color:var(--restaurant-color)"></i><span>Restaurant</span></div>
      <div class="dept-item" data-dept="kitchen" onclick="showInventory('kitchen')"><i class="fas fa-kitchen-set" style="color:var(--kitchen-color)"></i><span>Kitchen</span></div>
      <div class="dept-item" data-dept="admin" onclick="showInventory('admin')"><i class="fas fa-user-gear" style="color:var(--admin-color)"></i><span>Admin</span></div>
      <div class="dept-item" data-dept="grounds" onclick="showInventory('grounds')"><i class="fas fa-tree" style="color:var(--grounds-color)"></i><span>Grounds</span></div>
      <div class="dept-item" data-dept="cultivation" onclick="showInventory('cultivation')"><i class="fas fa-seedling" style="color:var(--cultivation-color)"></i><span>Cultivation</span></div>
      <div id="userManagementMenuItem" class="dept-item hidden" data-dept="users" onclick="showUserManagement()"><i class="fas fa-users" style="color:var(--admin-color)"></i><span>User Management</span></div>
      <div id="categoryManagementMenuItem" class="dept-item hidden" data-dept="categories" onclick="showCategoryManagement()"><i class="fas fa-layer-group" style="color:var(--admin-color)"></i><span>Categories</span></div>
    </nav>
    <main class="content-area">
      <div id="dashboardContent" class="view-content">
        <h1 style="margin-bottom:2rem;font-size:2rem;font-weight:700">Dashboard</h1>
        <div class="dashboard-grid">
          <div class="card"><div class="card-header"><div class="card-title">Total Items</div></div><div class="card-metric" id="totalItems">0</div><div class="card-subtitle">Across all departments</div></div>
          <div class="card"><div class="card-header"><div class="card-title">Low Stock Alerts</div></div><div class="card-metric" id="lowStockCount" style="color:var(--accent)">0</div><div class="card-subtitle">Items need restocking</div></div>
          <div class="card"><div class="card-header"><div class="card-title">Today's Movements</div></div><div class="card-metric" id="todayMovements">0</div><div class="card-subtitle">Stock in/out operations</div></div>
          <div class="card"><div class="card-header"><div class="card-title">Active Users</div></div><div class="card-metric" id="activeUsers">0</div><div class="card-subtitle">Staff members registered</div></div>
          <div class="card"><div class="card-header"><div class="card-title">Quick Actions</div></div><div class="actions-grid">
            <div class="action-btn" onclick="showStockIn()"><i class="fas fa-box-archive"></i><div>Stock In</div></div>
            <div class="action-btn" onclick="showStockOut()"><i class="fas fa-arrow-right-from-bracket"></i><div>Stock Out</div></div>
            <div class="action-btn" onclick="showInventory()"><i class="fas fa-clipboard-list"></i><div>Inventory</div></div>
            <div class="action-btn" onclick="showReports()"><i class="fas fa-chart-line"></i><div>Reports</div></div>
            <div class="action-btn" onclick="showAddItem()"><i class="fas fa-plus"></i><div>Add Item</div></div>
            <div class="action-btn" onclick="showSettings()"><i class="fas fa-gear"></i><div>Settings</div></div>
          </div></div>
          <div class="activity-list"><div class="card-header"><div class="card-title">Recent Activity</div></div><div id="recentActivity"></div></div>
        </div>
      </div>
      <div id="actionContent" class="view-content hidden"></div>
      <div id="userManagementContent" class="view-content hidden"></div>
    </main>
  </div>
</div>

<script>
/* ========= CONFIG ========= */
const SUPABASE_URL = 'https://pylxzlryqrhlpnkkwyjf.supabase.co';
const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InB5bHh6bHJ5cXJobHBua2t3eWpmIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTM1OTcxNDUsImV4cCI6MjA2OTE3MzE0NX0.1dlDfWCkpsAvX7FmCt_nlq2nxCONxCqBL4yd8eBCtYI';
const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
const APP_VERSION = '1.4.0';
const USER_ROLES = { ADMIN:'admin', PROCESSOR:'processor', VIEWER:'viewer' };
const TELEGRAM_BOT = '7960256341:AAFw_BPZRibbnBLaSYD9Lf3id5Fw3352wDC';
const TELEGRAM_CHAT = '1212406500';

let currentUser = null, currentPin = '', pendingStockOut = null;
let state = { departments:{}, categories:{}, items:{}, stockLevels:{}, stockMovements:[], notifications:[], users:{}, version:APP_VERSION };
let offlineQueue = [];

/* ===== IndexedDB ===== */
async function initIDB(){
  return new Promise((res,rej)=>{
    const req = indexedDB.open('VanguardStockDB',4);
    req.onerror = e=>rej(e.target.error);
    req.onupgradeneeded=e=>{
      const db=e.target.result;
      if(!db.objectStoreNames.contains('state')) db.createObjectStore('state');
      if(!db.objectStoreNames.contains('offlineQueue')) db.createObjectStore('offlineQueue',{autoIncrement:true});
    };
    req.onsuccess = e=>res(e.target.result);
  });
}
async function saveState(){
  try{const db=await initIDB();const tx=db.transaction(['state'],'readwrite');state.version=APP_VERSION;tx.objectStore('state').put(state,'appState');await new Promise(r=>tx.oncomplete=r);}catch{}
}
async function loadState(){
  try{
    const db=await initIDB();
    const req=db.transaction(['state'],'readonly').objectStore('state').get('appState');
    await new Promise(r=>{
      req.onsuccess=e=>{
        const res=e.target.result;
        if(res && res.version === APP_VERSION) {
          state = res;
          
          // Add timestamps to existing objects if missing
          Object.values(state.items).forEach(item => {
            if (!item.updated_at) item.updated_at = new Date().toISOString();
          });
          Object.values(state.categories).forEach(cat => {
            if (!cat.updated_at) cat.updated_at = new Date().toISOString();
          });
          Object.values(state.users).forEach(user => {
            if (!user.updated_at) user.updated_at = new Date().toISOString();
          });
          state.stockMovements.forEach(move => {
            if (!move.updated_at) move.updated_at = new Date().toISOString();
          });
        } else {
          initDefault();
        }
        r();
      };
    });
  } catch {
    initDefault();
  }
}
async function resetApp(){
  if(!confirm('Reset will erase all local data. Continue?')) return;
  try{const db=await initIDB();const tx=db.transaction(['state','offlineQueue'],'readwrite');tx.objectStore('state').clear();tx.objectStore('offlineQueue').clear();await new Promise(r=>tx.oncomplete=r);initDefault();offlineQueue=[];saveState();location.reload();}catch{}
}
async function addOffline(op){try{const db=await initIDB();const tx=db.transaction(['offlineQueue'],'readwrite');tx.objectStore('offlineQueue').add(op);offlineQueue.push(op);}catch{}}
async function loadQueue(){try{const db=await initIDB();const res=await db.transaction(['offlineQueue'],'readonly').objectStore('offlineQueue').getAll();offlineQueue=res||[];}catch{offlineQueue=[];}}
async function clearQueue(){try{const db=await initIDB();db.transaction(['offlineQueue'],'readwrite').objectStore('offlineQueue').clear();offlineQueue.length=0;}catch{}}

/* ===== Default Data ===== */
function initDefault(){
  state={departments:{},categories:{},items:{},stockLevels:{},stockMovements:[],notifications:[],users:{},version:APP_VERSION};
  const DEPT_CFG={
    hotel:{name:'Hotel Ops',cats:['Linens','Toiletries','Cleaning','Amenities','Maintenance']},
    bar:{name:'Bar',cats:['Spirits','Wines','Beers','Mixers','Garnishes','Glassware']},
    restaurant:{name:'Restaurant',cats:['Beverages','Tableware','Linens','Service']},
    kitchen:{name:'Kitchen',cats:['Fresh Produce','Meat','Dairy','Dry Goods','Spices']},
    admin:{name:'Admin',cats:['Office','IT','Docs']},
    grounds:{name:'Grounds',cats:['Tools','Fertilizer','Pesticides']},
    cultivation:{name:'Cultivation',cats:['Seeds','Soil','Nutrients']}
  };
  Object.keys(DEPT_CFG).forEach(k=>{
    const dId=`dept_${k}`;
    state.departments[dId]={id:dId,name:DEPT_CFG[k].name, updated_at: new Date().toISOString()};
    DEPT_CFG[k].cats.forEach(c=>{
      const cId=`cat_${k}_${c.toLowerCase().replace(/\s+/g,'')}`;
      state.categories[cId]={id:cId,departmentId:dId,name:c, updated_at: new Date().toISOString()};
    });
  });
  state.users={
    Kelvin:{username:'Kelvin',password:'0100*',role:USER_ROLES.ADMIN,displayName:'Kelvin',department:'all', updated_at: new Date().toISOString()},
    Franklin:{username:'Franklin',password:'1100%',role:USER_ROLES.ADMIN,displayName:'Franklin',department:'all', updated_at: new Date().toISOString()},
    Chisomo:{username:'Chisomo',password:'2100%',role:USER_ROLES.ADMIN,displayName:'Chisomo',department:'admin', updated_at: new Date().toISOString()},
    Victor:{username:'Victor',password:'02000',role:USER_ROLES.ADMIN,displayName:'Victor',department:'admin', updated_at: new Date().toISOString()},
    Boston:{username:'Boston',password:'61006',role:USER_ROLES.PROCESSOR,displayName:'Boston',department:'bar', updated_at: new Date().toISOString()},
    Magah:{username:'Magah',password:'41004',role:USER_ROLES.PROCESSOR,displayName:'Magah',department:'bar', updated_at: new Date().toISOString()},
    Phillip:{username:'Phillip',password:'51005',role:USER_ROLES.PROCESSOR,displayName:'Phillip',department:'bar',isSupervisor:true, updated_at: new Date().toISOString()},
    Gift:{username:'Gift',password:'71007',role:USER_ROLES.PROCESSOR,displayName:'Gift',department:'restaurant', updated_at: new Date().toISOString()},
    Rhodney:{username:'Rhodney',password:'81008',role:USER_ROLES.PROCESSOR,displayName:'Rhodney',department:'restaurant',isSupervisor:true, updated_at: new Date().toISOString()},
    Mike:{username:'Mike',password:'91009',role:USER_ROLES.PROCESSOR,displayName:'Mike',department:'restaurant', updated_at: new Date().toISOString()},
    Matias:{username:'Matias',password:'11100',role:USER_ROLES.PROCESSOR,displayName:'Matias',department:'hotel', updated_at: new Date().toISOString()},
    Kennedy:{username:'Kennedy',password:'22202',role:USER_ROLES.PROCESSOR,displayName:'Kennedy',department:'hotel', updated_at: new Date().toISOString()},
    Mphatso:{username:'Mphatso',password:'33303',role:USER_ROLES.PROCESSOR,displayName:'Mphatso',department:'restaurant', updated_at: new Date().toISOString()},
    Gaven:{username:'Gaven',password:'44404',role:USER_ROLES.PROCESSOR,displayName:'Gaven',department:'grounds', updated_at: new Date().toISOString()},
    Maya:{username:'Maya',password:'55505',role:USER_ROLES.PROCESSOR,displayName:'Maya',department:'grounds', updated_at: new Date().toISOString()}
  };
}

/* ===== UTILS ===== */
const genId = () => `id_${Date.now()}_${Math.random().toString(36).slice(2,9)}`;
const sendTG = msg => {
  if(!TELEGRAM_BOT||!TELEGRAM_CHAT) return;
  fetch(`https://api.telegram.org/bot${TELEGRAM_BOT}/sendMessage`,{
    method:'POST',headers:{'Content-Type':'application/json'},
    body:JSON.stringify({chat_id:TELEGRAM_CHAT,text:msg,parse_mode:'Markdown'})
  }).catch(()=>{});
};

/* ===== CORE OPS ===== */
function addItem(d){
  const id=genId();
  state.items[id]={
    id,
    name:d.name,
    categoryId:d.categoryId,
    unit:d.unit,
    cost:+d.cost||0,
    minStockLevel:+d.minStockLevel||0,
    createdAt:new Date().toISOString(),
    updated_at: new Date().toISOString() // Add timestamp
  };
  state.stockLevels[id]={item_id:id,quantity:+d.initialQuantity||0};
  logMove(id,'in',+d.initialQuantity,'Initial stock');
  addOffline({type:'ADD_ITEM',data:state.items[id],initialQuantity:+d.initialQuantity||0});
  saveState();updateDash();renderAct();return id;
}
function logMove(i,t,q,r,s=null,p=null){
  const move = {
    id:genId(),
    item_id:i,
    type:t,
    quantity:q,
    reason:r,
    user:currentUser.displayName,
    staff_member:s,
    confirmedPin:p,
    timestamp:new Date().toISOString(),
    updated_at: new Date().toISOString() // Add timestamp
  };
  state.stockMovements.unshift(move);
  saveState();
}
function adjustStock(itemId,qty,reason,staff=null,pin=null){
  const item=state.items[itemId],stock=state.stockLevels[itemId];
  if(!item||!stock){showMsg('Item not found','error');return false;}
  if(stock.quantity+qty<0){showMsg('Negative stock','error');return false;}
  const old=stock.quantity;
  stock.quantity+=qty;
  
  // Update item timestamp
  item.updated_at = new Date().toISOString();
  
  const type=qty>0?'in':'out';
  logMove(itemId,type,Math.abs(qty),reason,staff,pin);
  addOffline({type:'STOCK_MOVEMENT',data:{item_id:itemId,type,quantity:Math.abs(qty),reason,user:currentUser.displayName,staff_member:staff,confirmedPin:pin,timestamp:new Date().toISOString(), updated_at: new Date().toISOString()}});
  saveState();updateDash();renderAct();
  if(type==='out'){
    const staffName=staff?state.users[staff]?.displayName||staff:'Unknown';
    sendTG(`âœ… **STOCK ISSUED**\n\nItem: **${item.name}**\nQty: **${Math.abs(qty)} ${item.unit}**\nTo: **${staffName}**\nPIN: **${pin||'Admin'}**`);
    if(old>item.minStockLevel&&stock.quantity<=item.minStockLevel){
      const msg=`ðŸš¨ **LOW STOCK**\n\nItem: **${item.name}**\nQty: **${stock.quantity}/${item.minStockLevel} ${item.unit}**`;
      sendTG(msg);
      state.notifications.unshift({id:genId(),message:msg,timestamp:new Date().toISOString(),read:false});
      saveState();
    }
  }
  return true;
}
function updateDash(){
  document.getElementById('totalItems').textContent=Object.keys(state.items).length;
  document.getElementById('lowStockCount').textContent=Object.values(state.items).filter(i=>(state.stockLevels[i.id]?.quantity||0)<=i.minStockLevel).length;
  const today=new Date().toDateString();
  document.getElementById('todayMovements').textContent=state.stockMovements.filter(m=>new Date(m.timestamp).toDateString()===today).length;
  document.getElementById('activeUsers').textContent=Object.keys(state.users).length;
}
function renderAct(){
  const feed=document.getElementById('recentActivity');feed.innerHTML='';
  if(!state.stockMovements.length){feed.innerHTML='<p style="text-align:center;color:var(--text-secondary);padding:2rem">No recent activity.</p>';return;}
  state.stockMovements.slice(0,5).forEach(m=>{
    const item=state.items[m.item_id];if(!item)return;
    const icon=m.type==='in'?'fa-arrow-down':'fa-arrow-up';
    const color=m.type==='in'?'var(--success)':'var(--accent)';
    const staff=m.staff_member?state.users[m.staff_member]?.displayName||m.staff_member:'Unknown';
    const time=new Date(m.timestamp).toLocaleString();
    feed.innerHTML+=`<div class="activity-item">
      <div class="activity-avatar" style="color:${color}"><i class="fas ${icon}"></i></div>
      <div class="activity-content">
        <div class="activity-text">${m.user} ${m.type==='in'?'stocked in':'issued'} ${m.quantity} ${item.unit} of ${item.name}${m.type==='out'?` to ${staff}`:''}.</div>
        <div class="activity-time">${time}</div>
      </div>
    </div>`;
  });
}
function switchView(view,html=''){
  document.querySelectorAll('.view-content').forEach(v=>v.classList.add('hidden'));
  const el=document.getElementById(view);
  if(html) el.innerHTML=html;
  el.classList.remove('hidden');
  el.style.animation='fadeIn .3s';
}
function showMsg(text,type){
  const m=document.createElement('div');m.className=`message ${type} show`;m.textContent=text;
  document.querySelector('.content-area').prepend(m);setTimeout(()=>m.remove(),4000);
}

/* ===== LOGIN ===== */
let loginScreen=document.getElementById('loginScreen');
let pinDigits=document.querySelectorAll('.pin-digit');
function clearPin(){
  currentPin='';
  pinDigits.forEach(d=>{d.value='';d.classList.remove('filled');});
  pinDigits[0].focus();
  document.getElementById('loginMessage').className='message';
}
function handleKeyPress(key){
  const msg=document.getElementById('loginMessage');
  msg.className='message';
  if(currentPin.length>=pinDigits.length)return;
  const currentDigit=pinDigits[currentPin.length];
  currentDigit.value=key;
  currentDigit.classList.add('filled');
  currentPin+=key;
  if(currentPin.length===pinDigits.length)attemptLogin();
}
function attemptLogin(){
  let foundUser=null;
  for(const username in state.users){
    if(state.users[username].password===currentPin){foundUser=state.users[username];break;}
  }
  if(foundUser){login(foundUser);}
  else{
    const msg=document.getElementById('loginMessage');
    msg.textContent='Invalid PIN or insufficient permissions.';
    msg.className='message error show';
    document.querySelector('.login-card').style.animation='shake .5s';
    setTimeout(()=>{document.querySelector('.login-card').style.animation='';clearPin();},500);
  }
}
function login(user){
  currentUser=user;
  document.getElementById('currentUser').textContent=`Welcome, ${user.displayName}`;
  if(user.displayName==='Franklin'){
    document.getElementById('userManagementMenuItem').classList.remove('hidden');
    document.getElementById('categoryManagementMenuItem').classList.remove('hidden');
  }
  setTimeout(()=>{
    loginScreen.classList.add('hidden');
    document.getElementById('mainApp').classList.remove('hidden');
    updateDash();renderAct();updateSyncStatus();
  },500);
}
function logout(){
  currentUser=null;clearPin();
  document.getElementById('mainApp').classList.add('hidden');
  loginScreen.classList.remove('hidden');
}

/* ===== SYNC (FIXED) ===== */
async function syncData(){
  const ind=document.getElementById('syncIndicator');
  const txt=document.getElementById('syncStatus');
  ind.className='sync-indicator syncing';txt.textContent='Syncingâ€¦';
  try{
    // Process offline queue first (push local changes)
    await processOfflineQueue();
    
    // Then pull from Supabase (fetch remote changes)
    await pullFromSupabase();
    
    // Save merged state
    await saveState();
    
    updateDash();renderAct();
    showMsg('Sync completed','success');
  }catch(e){
    console.error(e);showMsg('Sync failed: '+e.message,'error');
  }finally{
    ind.className='sync-indicator';updateSyncStatus();
  }
}

async function processOfflineQueue(){
  if(!offlineQueue.length)return;
  for(const op of offlineQueue){
    try{
      // Add update timestamp to all operations
      const updateData = {
        ...op.data,
        updated_at: new Date().toISOString()
      };
      
      switch(op.type){
        case 'ADD_ITEM':
          await supabase.from('items').insert(updateData);
          await supabase.from('stock_levels').insert({item_id:op.data.id,quantity:op.initialQuantity});
          break;
        case 'UPDATE_ITEM':
          await supabase.from('items').update(updateData).eq('id',op.id);
          break;
        case 'DELETE_ITEM':
          await supabase.from('items').delete().eq('id',op.id);
          await supabase.from('stock_levels').delete().eq('item_id',op.id);
          break;
        case 'STOCK_MOVEMENT':
          await supabase.from('stock_movements').insert(updateData);
          const {data:row}=await supabase.from('stock_levels').select('quantity').eq('item_id',op.data.item_id).single();
          let newQty=(row?.quantity||0)+(op.data.type==='in'?op.data.quantity:-op.data.quantity);
          await supabase.from('stock_levels').upsert({item_id:op.data.item_id,quantity:newQty});
          break;
        case 'ADD_CATEGORY':
          await supabase.from('categories').insert(updateData);
          break;
        case 'UPDATE_CATEGORY':
          await supabase.from('categories').update(updateData).eq('id',op.id);
          break;
        case 'DELETE_CATEGORY':
          await supabase.from('categories').delete().eq('id',op.id);
          break;
        case 'ADD_USER':
          await supabase.from('users').insert(updateData);
          break;
        case 'UPDATE_USER':
          await supabase.from('users').update(updateData).eq('username',op.id);
          break;
        case 'DELETE_USER':
          await supabase.from('users').delete().eq('username',op.id);
          break;
      }
    }catch(err){
      console.error(`Offline op failed: ${op.type}`, err);
      throw new Error(`${op.type} failed`);
    }
  }
  await clearQueue();
}

async function pullFromSupabase(){
  // Fetch data from Supabase
  const [deptRes, catRes, itemRes, levelRes, moveRes, userRes] = await Promise.all([
    supabase.from('departments').select('*'),
    supabase.from('categories').select('*'),
    supabase.from('items').select('*'),
    supabase.from('stock_levels').select('*'),
    supabase.from('stock_movements').select('*').order('timestamp', { ascending: false }).limit(1000),
    supabase.from('users').select('*')
  ]);

  // Merge instead of replace
  mergeState({
    departments: deptRes.data || [],
    categories: catRes.data || [],
    items: itemRes.data || [],
    stockLevels: levelRes.data || [],
    stockMovements: moveRes.data || [],
    users: userRes.data || []
  });
}

function mergeState(remoteData){
  // Helper function to merge arrays by ID with conflict resolution
  const mergeById = (local, remote) => {
    const merged = {...local};
    
    for (const remoteEntity of remote) {
      const localEntity = local[remoteEntity.id];
      
      // Conflict resolution: Use most recent update
      if (localEntity && localEntity.updated_at && remoteEntity.updated_at) {
        if (new Date(localEntity.updated_at) > new Date(remoteEntity.updated_at)) {
          continue; // Keep local version
        }
      }
      
      merged[remoteEntity.id] = remoteEntity;
    }
    return merged;
  };

  // Merge each data type
  state.departments = mergeById(state.departments, remoteData.departments);
  state.categories = mergeById(state.categories, remoteData.categories);
  state.items = mergeById(state.items, remoteData.items);
  
  // Special handling for stock levels (merge quantities)
  for (const level of remoteData.stockLevels) {
    if (!state.stockLevels[level.item_id]) {
      state.stockLevels[level.item_id] = level;
    } else {
      // Take max quantity to prevent data loss
      state.stockLevels[level.item_id].quantity = Math.max(
        state.stockLevels[level.item_id].quantity,
        level.quantity
      );
    }
  }
  
  // Merge users (prioritize remote)
  state.users = {...state.users, ...remoteData.users.reduce((acc, user) => {
    acc[user.username] = user;
    return acc;
  }, {})};
  
  // Merge stock movements (remove duplicates)
  const movementIds = new Set(state.stockMovements.map(m => m.id));
  for (const movement of remoteData.stockMovements) {
    if (!movementIds.has(movement.id)) {
      state.stockMovements.push(movement);
    }
  }
  
  // Sort by timestamp
  state.stockMovements.sort((a, b) => 
    new Date(b.timestamp) - new Date(a.timestamp)
  );
}

function updateSyncStatus(){
  const ind=document.getElementById('syncIndicator');
  const txt=document.getElementById('syncStatus');
  if(!navigator.onLine){ind.className='sync-indicator offline';txt.textContent='Offline';return;}
  if(offlineQueue.length){ind.className='sync-indicator';txt.textContent=`${offlineQueue.length} pending`;}
  else{ind.className='sync-indicator';txt.textContent='Online';}
}

/* ===== VIEWS ===== */
function showDashboard(){switchView('dashboardContent');document.querySelectorAll('.dept-item').forEach(d=>d.classList.remove('active'));document.querySelector('[data-dept="dashboard"]').classList.add('active');updateDash();renderAct();}
function showStockIn(){
  const items=Object.values(state.items).map(i=>`<option value="${i.id}">${i.name}</option>`).join('');
  switchView('actionContent',`
    <div class="card">
      <div class="card-header"><div class="card-title">Stock In</div><button class="logout-btn" onclick="showDashboard()"><i class="fas fa-arrow-left"></i></button></div>
      <form id="stockInForm">
        <div class="form-grid">
          <div class="form-group"><label>Item</label><select id="siItem" required>${items}</select></div>
          <div class="form-group"><label>Quantity</label><input type="number" id="siQty" required min="0.01" step="any"></div>
          <div class="form-group"><label>Reason</label><input id="siReason" value="Supplier delivery" required></div>
        </div>
        <div class="form-actions"><button type="button" class="btn btn-secondary" onclick="showDashboard()">Cancel</button><button type="submit" class="btn btn-primary">Add</button></div>
      </form>
    </div>`);
  document.getElementById('stockInForm').addEventListener('submit',e=>{e.preventDefault();adjustStock(siItem.value,+siQty.value,siReason.value);showDashboard();});
}
function showStockOut(){
  const items=Object.values(state.items).map(i=>`<option value="${i.id}">${i.name} (Avail: ${state.stockLevels[i.id]?.quantity||0})</option>`).join('');
  const staff=Object.values(state.users).map(u=>`<option value="${u.username}">${u.displayName}</option>`).join('');
  switchView('actionContent',`
    <div class="card">
      <div class="card-header"><div class="card-title">Stock Out</div><button class="logout-btn" onclick="showDashboard()"><i class="fas fa-arrow-left"></i></button></div>
      <form id="stockOutForm">
        <div class="form-grid">
          <div class="form-group"><label>Item</label><select id="soItem" required>${items}</select></div>
          <div class="form-group"><label>Quantity</label><input type="number" id="soQty" required min="0.01" step="any"></div>
          <div class="form-group"><label>Issued To</label><select id="soStaff" required>${staff}</select></div>
          <div class="form-group"><label>Reason</label><input id="soReason" value="Department usage" required></div>
        </div>
        <div class="form-actions">
          <button type="button" class="btn btn-secondary" onclick="showDashboard()">Cancel</button>
          <button type="button" id="soBtn" class="btn btn-primary">Remove</button>
        </div>
      </form>
    </div>`);
  document.getElementById('soBtn').addEventListener('click',()=>{
    const itemId=document.getElementById('soItem').value;
    const qty=+document.getElementById('soQty').value;
    const staff=document.getElementById('soStaff').value;
    const reason=document.getElementById('soReason').value;
    const staffObj=state.users[staff];
    if(!qty||qty<=0){showMsg('Enter valid quantity','error');return;}
    if(staffObj&&staffObj.role!==USER_ROLES.ADMIN){
      pendingStockOut={itemId,qty,staff,reason};
      openInlinePin();
    }else{adjustStock(itemId,-qty,reason,staff);showDashboard();}
  });
}
function showInventory(dept=null){
  let rows='';
  Object.values(state.items).forEach(i=>{
    const cat=state.categories[i.categoryId],deptObj=cat?state.departments[cat.departmentId]:null;
    if(dept&&deptObj?.id!==`dept_${dept}`) return;
    const stock=state.stockLevels[i.id]||{quantity:0};
    rows+=`<tr>
      <td>${i.name}</td><td>${cat?.name||'-'}</td><td>${deptObj?.name||'-'}</td>
      <td>${stock.quantity} ${i.unit}</td><td>${i.minStockLevel} ${i.unit}</td>
      <td>${currentUser?.role===USER_ROLES.ADMIN?`<button class="btn-icon" onclick="editItemForm('${i.id}')" title="Edit"><i class="fas fa-edit"></i></button><button class="btn-icon" onclick="deleteItemPrompt('${i.id}')" title="Delete"><i class="fas fa-trash"></i></button>`:''}</td>
    </tr>`;
  });
  if(!rows) rows='<tr><td colspan="6">No items</td></tr>';
  switchView('actionContent',`
    <div class="card">
      <div class="card-header"><div class="card-title">Inventory ${dept?`- ${state.departments['dept_'+dept]?.name}`:''}</div>${currentUser?.role===USER_ROLES.ADMIN?`<button class="logout-btn" onclick="showAddItem()"><i class="fas fa-plus"></i> Add Item</button>`:''}</div>
      <div class="data-table-container"><table class="data-table"><thead><tr><th>Name</th><th>Category</th><th>Dept</th><th>Qty</th><th>Min</th><th></th></tr></thead><tbody>${rows}</tbody></table></div>
    </div>`);
}
function showAddItem(){
  const cats=Object.values(state.categories).map(c=>`<option value="${c.id}">${state.departments[c.departmentId].name} - ${c.name}</option>`).join('');
  switchView('actionContent',`
    <div class="card">
      <div class="card-header"><div class="card-title">Add Item</div><button class="logout-btn" onclick="showInventory()"><i class="fas fa-arrow-left"></i></button></div>
      <form id="addItemForm">
        <div class="form-grid">
          <div class="form-group"><label>Name</label><input id="aiName" required></div>
          <div class="form-group"><label>Category</label><select id="aiCat" required>${cats}</select></div>
          <div class="form-group"><label>Unit</label><input id="aiUnit" required></div>
          <div class="form-group"><label>Cost</label><input type="number" id="aiCost" value="0" step="any"></div>
          <div class="form-group"><label>Initial Qty</label><input type="number" id="aiQty" value="0" step="any"></div>
          <div class="form-group"><label>Min Stock</label><input type="number" id="aiMin" value="0" step="any"></div>
        </div>
        <div class="form-actions"><button type="button" class="btn btn-secondary" onclick="showInventory()">Cancel</button><button type="submit" class="btn btn-primary">Add</button></div>
      </form>
    </div>`);
  document.getElementById('addItemForm').addEventListener('submit',e=>{e.preventDefault();addItem({name:aiName.value,categoryId:aiCat.value,unit:aiUnit.value,cost:+aiCost.value,initialQuantity:+aiQty.value,minStockLevel:+aiMin.value});showInventory();});
}
function editItemForm(id){
  const i=state.items[id];if(!i)return;
  const cats=Object.values(state.categories).map(c=>`<option value="${c.id}" ${c.id===i.categoryId?'selected':''}>${state.departments[c.departmentId].name} - ${c.name}</option>`).join('');
  switchView('actionContent',`
    <div class="card">
      <div class="card-header"><div class="card-title">Edit ${i.name}</div><button class="logout-btn" onclick="showInventory()"><i class="fas fa-arrow-left"></i></button></div>
      <form id="editItemForm">
        <div class="form-grid">
          <div class="form-group"><label>Name</label><input id="eiName" value="${i.name}" required></div>
          <div class="form-group"><label>Category</label><select id="eiCat">${cats}</select></div>
          <div class="form-group"><label>Unit</label><input id="eiUnit" value="${i.unit}" required></div>
          <div class="form-group"><label>Cost</label><input type="number" id="eiCost" value="${i.cost}" step="any"></div>
          <div class="form-group"><label>Min Stock</label><input type="number" id="eiMin" value="${i.minStockLevel}" step="any"></div>
        </div>
        <div class="form-actions"><button type="button" class="btn btn-secondary" onclick="showInventory()">Cancel</button><button type="submit" class="btn btn-primary">Save</button></div>
      </form>
    </div>`);
  document.getElementById('editItemForm').addEventListener('submit',e=>{
    e.preventDefault();
    // Update timestamp on edit
    Object.assign(i,{
      name:eiName.value,
      categoryId:eiCat.value,
      unit:eiUnit.value,
      cost:+eiCost.value,
      minStockLevel:+eiMin.value,
      updated_at: new Date().toISOString()
    });
    addOffline({type:'UPDATE_ITEM',id,data:i});saveState();showInventory();
  });
}
function deleteItemPrompt(id){
  if(!confirm('Delete this item?'))return;
  delete state.items[id];delete state.stockLevels[id];
  state.stockMovements=state.stockMovements.filter(m=>m.item_id!==id);
  addOffline({type:'DELETE_ITEM',id});saveState();updateDash();renderAct();showInventory();
}
function showReports(){
  const inStock=Object.values(state.items).filter(i=>(state.stockLevels[i.id]?.quantity||0)>i.minStockLevel).length;
  const low=Object.values(state.items).filter(i=>{const s=state.stockLevels[i.id]?.quantity||0;return s>0&&s<=i.minStockLevel}).length;
  const out=Object.values(state.items).length-inStock-low;
  switchView('actionContent',`
    <div class="card">
      <div class="card-header"><div class="card-title">Reports</div><button class="logout-btn" onclick="showDashboard()"><i class="fas fa-arrow-left"></i></button></div>
      <div class="charts-grid">
        <div class="chart-container"><canvas id="stockChart"></canvas></div>
        <div class="chart-container"><canvas id="deptChart"></canvas></div>
      </div>
    </div>`);
  setTimeout(()=>{
    new Chart(document.getElementById('stockChart'),{type:'doughnut',data:{labels:['In Stock','Low','Out'],datasets:[{data:[inStock,low,out],backgroundColor:['var(--success)','var(--warning)','var(--accent)']}]}});
    const deptVal={};Object.values(state.items).forEach(i=>{
      const c=state.categories[i.categoryId];const d=c?state.departments[c.departmentId]:null;if(!d)return;
      const v=(state.stockLevels[i.id]?.quantity||0)*i.cost;deptVal[d.name]=(deptVal[d.name]||0)+v;
    });
    new Chart(document.getElementById('deptChart'),{type:'bar',data:{labels:Object.keys(deptVal),datasets:[{label:'Value',data:Object.values(deptVal),backgroundColor:'var(--secondary)'}]}});
  },100);
}
function showSettings(){
  switchView('actionContent',`
    <div class="card">
      <div class="card-header"><div class="card-title">Settings</div><button class="logout-btn" onclick="showDashboard()"><i class="fas fa-arrow-left"></i></button></div>
      <button class="btn btn-primary" onclick="sendTG('âœ… Vanguard test message')">Test Telegram</button>
    </div>`);
}

/* ===== CATEGORY CRUD (Admin) ===== */
function addCategory(deptId, catName){
  const id=`cat_${deptId}_${catName.toLowerCase().replace(/\s+/g,'')}`;
  if(state.categories[id]){showMsg('Category already exists','error');return;}
  state.categories[id]={id,departmentId:deptId,name:catName, updated_at: new Date().toISOString()};
  addOffline({type:'ADD_CATEGORY',data:state.categories[id]});
  saveState();showMsg('Category added','success');
}
function updateCategory(id,newName){
  state.categories[id].name=newName;
  state.categories[id].updated_at = new Date().toISOString(); // Update timestamp
  addOffline({type:'UPDATE_CATEGORY',id,data:state.categories[id]});
  saveState();showMsg('Category updated','success');
}
function deleteCategory(id){
  const inUse=Object.values(state.items).some(i=>i.categoryId===id);
  if(inUse){showMsg('Category in use â€“ cannot delete','error');return;}
  delete state.categories[id];
  addOffline({type:'DELETE_CATEGORY',id});
  saveState();showMsg('Category deleted','success');
}
function showCategoryManagement(){
  if(currentUser?.displayName!=='Franklin')return;
  const cats=Object.values(state.categories).map(c=>{
    const d=state.departments[c.departmentId];
    return `<tr>
      <td>${d.name}</td><td>${c.name}</td>
      <td>
        <button class="btn-icon" onclick="editCategoryForm('${c.id}')" title="Edit"><i class="fas fa-edit"></i></button>
        <button class="btn-icon" onclick="deleteCategory('${c.id}')" title="Delete"><i class="fas fa-trash"></i></button>
      </td>
    </tr>`;
  }).join('');
  switchView('actionContent',`
    <div class="card">
      <div class="card-header">
        <div class="card-title">Category Management</div>
        <button class="logout-btn" onclick="showDashboard()"><i class="fas fa-arrow-left"></i></button>
        <button class="logout-btn" onclick="addCategoryForm()"><i class="fas fa-plus"></i> Add Category</button>
      </div>
      <table class="data-table"><thead><tr><th>Department</th><th>Name</th><th></th></tr></thead><tbody>${cats}</tbody></table>
    </div>`);
}
function addCategoryForm(){
  const depts=Object.values(state.departments).map(d=>`<option value="${d.id}">${d.name}</option>`).join('');
  switchView('actionContent',`
    <div class="card">
      <div class="card-header"><div class="card-title">Add Category</div><button class="logout-btn" onclick="showCategoryManagement()"><i class="fas fa-arrow-left"></i></button></div>
      <form id="addCatForm">
        <div class="form-grid">
          <div class="form-group"><label>Department</label><select id="acDept" required>${depts}</select></div>
          <div class="form-group"><label>Category Name</label><input id="acName" required></div>
        </div>
        <div class="form-actions"><button type="button" class="btn btn-secondary" onclick="showCategoryManagement()">Cancel</button><button type="submit" class="btn btn-primary">Add</button></div>
      </form>
    </div>`);
  document.getElementById('addCatForm').addEventListener('submit',e=>{
    e.preventDefault();
    addCategory(acDept.value,acName.value);
    showCategoryManagement();
  });
}
function editCategoryForm(id){
  const c=state.categories[id];
  const depts=Object.values(state.departments).map(d=>`<option value="${d.id}" ${d.id===c.departmentId?'selected':''}>${d.name}</option>`).join('');
  switchView('actionContent',`
    <div class="card">
      <div class="card-header"><div class="card-title">Edit Category</div><button class="logout-btn" onclick="showCategoryManagement()"><i class="fas fa-arrow-left"></i></button></div>
      <form id="editCatForm">
        <div class="form-grid">
          <div class="form-group"><label>Department</label><select id="ecDept">${depts}</select></div>
          <div class="form-group"><label>Name</label><input id="ecName" value="${c.name}" required></div>
        </div>
        <div class="form-actions"><button type="button" class="btn btn-secondary" onclick="showCategoryManagement()">Cancel</button><button type="submit" class="btn btn-primary">Save</button></div>
      </form>
    </div>`);
  document.getElementById('editCatForm').addEventListener('submit',e=>{
    e.preventDefault();
    updateCategory(id,ecName.value);
    showCategoryManagement();
  });
}
function showUserManagement(){
  if(currentUser?.displayName!=='Franklin'){showMsg('Access denied','error');return;}
  const rows=Object.values(state.users).map(u=>`
    <tr>
      <td>${u.username}</td><td>${u.displayName}</td><td>${u.role}</td><td>${u.department}</td>
      <td>
        <button class="btn-icon" onclick="editUserForm('${u.username}')"><i class="fas fa-edit"></i></button>
        <button class="btn-icon" onclick="deleteUserPrompt('${u.username}')"><i class="fas fa-trash"></i></button>
      </td>
    </tr>`).join('');
  switchView('userManagementContent',`
    <div class="card">
      <div class="card-header">
        <div class="card-title">User Management</div>
        <button class="logout-btn" onclick="showDashboard()"><i class="fas fa-arrow-left"></i></button>
        <button class="logout-btn" onclick="addUserForm()"><i class="fas fa-plus"></i> Add User</button>
      </div>
      <table class="data-table"><thead><tr><th>Username</th><th>Display</th><th>Role</th><th>Dept</th><th></th></tr></thead><tbody>${rows}</tbody></table>
    </div>`);
}
function addUserForm(){
  const depts=Object.values(state.departments).map(d=>`<option value="${d.id}">${d.name}</option>`).join('');
  switchView('userManagementContent',`
    <div class="card">
      <div class="card-header"><div class="card-title">Add User</div><button class="logout-btn" onclick="showUserManagement()"><i class="fas fa-arrow-left"></i></button></div>
      <form id="addUserForm">
        <div class="form-grid">
          <div class="form-group"><label>Username</label><input id="auUsername" required></div>
          <div class="form-group"><label>Display Name</label><input id="auDisplay" required></div>
          <div class="form-group"><label>Password (PIN)</label><input id="auPassword" required></div>
          <div class="form-group"><label>Role</label><select id="auRole"><option value="admin">Admin</option><option value="processor">Processor</option><option value="viewer">Viewer</option></select></div>
          <div class="form-group"><label>Department</label><select id="auDept"><option value="all">All</option>${depts}</select></div>
        </div>
        <div class="form-actions"><button type="button" class="btn btn-secondary" onclick="showUserManagement()">Cancel</button><button type="submit" class="btn btn-primary">Add</button></div>
      </form>
    </div>`);
  document.getElementById('addUserForm').addEventListener('submit',e=>{
    e.preventDefault();
    const username=auUsername.value,displayName=auDisplay.value,password=auPassword.value,role=auRole.value,department=auDept.value;
    if(state.users[username]){showMsg('User already exists','error');return;}
    state.users[username]={username,displayName,password,role,department, updated_at: new Date().toISOString()};
    addOffline({type:'ADD_USER',data:state.users[username]});saveState();showUserManagement();
  });
}
function editUserForm(username){
  const u=state.users[username];if(!u)return;
  const depts=Object.values(state.departments).map(d=>`<option value="${d.id}" ${d.id===u.department?'selected':''}>${d.name}</option>`).join('');
  switchView('userManagementContent',`
    <div class="card">
      <div class="card-header"><div class="card-title">Edit ${u.displayName}</div><button class="logout-btn" onclick="showUserManagement()"><i class="fas fa-arrow-left"></i></button></div>
      <form id="editUserForm">
        <div class="form-grid">
          <div class="form-group"><label>Username</label><input value="${u.username}" disabled></div>
          <div class="form-group"><label>Display Name</label><input id="euDisplay" value="${u.displayName}" required></div>
          <div class="form-group"><label>Password (blank = no change)</label><input id="euPassword" placeholder="*****"></div>
          <div class="form-group"><label>Role</label><select id="euRole"><option value="admin" ${u.role==='admin'?'selected':''}>Admin</option><option value="processor" ${u.role==='processor'?'selected':''}>Processor</option><option value="viewer" ${u.role==='viewer'?'selected':''}>Viewer</option></select></div>
          <div class="form-group"><label>Department</label><select id="euDept"><option value="all" ${u.department==='all'?'selected':''}>All</option>${depts}</select></div>
        </div>
        <div class="form-actions"><button type="button" class="btn btn-secondary" onclick="showUserManagement()">Cancel</button><button type="submit" class="btn btn-primary">Save</button></div>
      </form>
    </div>`);
  document.getElementById('editUserForm').addEventListener('submit',e=>{
    e.preventDefault();
    // Update timestamp on edit
    Object.assign(u,{
      displayName:euDisplay.value,
      password:euPassword.value||u.password,
      role:euRole.value,
      department:euDept.value,
      updated_at: new Date().toISOString()
    });
    addOffline({type:'UPDATE_USER',id:username,data:u});saveState();showUserManagement();
  });
}
function deleteUserPrompt(username){
  if(username===currentUser.username){showMsg('Cannot delete yourself','error');return;}
  if(!confirm(`Delete user ${username}?`))return;
  delete state.users[username];
  addOffline({type:'DELETE_USER',id:username});saveState();showUserManagement();
}

/* ===== INLINE KEYPAD ===== */
function buildInlineKeypad(){
  if(document.getElementById('inlineKeypad')) return;
  const div=document.createElement('div');div.id='inlineKeypad';
  div.style.cssText='position:fixed;inset:0;background:rgba(0,0,0,.6);display:none;align-items:center;justify-content:center;z-index:200';
  div.innerHTML=`
    <div class="modal-content">
      <h3>Confirm Receipt</h3><p>Enter your 5-digit PIN</p>
      <div class="pin-input">${'<input class="pin-digit" maxlength="1" readonly>'.repeat(5)}</div>
      <div class="keypad">${[1,2,3,4,5,6,7,8,9,'*',0,'%'].map(k=>`<button class="key" data-key="${k}">${k}</button>`).join('')}</div>
      <button class="clear-btn" onclick="cancelInlinePin()">Cancel</button>
    </div>`;
  document.body.appendChild(div);
}
function openInlinePin(){
  buildInlineKeypad();
  document.getElementById('inlineKeypad').style.display='flex';
  const digits=document.querySelectorAll('#inlineKeypad .pin-digit');
  digits.forEach(d=>{d.value='';d.classList.remove('filled');});digits[0].focus();
}
function cancelInlinePin(){document.getElementById('inlineKeypad')?.remove();pendingStockOut=null;}
function confirmInlinePin(){
  const pin=Array.from(document.querySelectorAll('#inlineKeypad .pin-digit')).map(d=>d.value).join('');
  if(pin.length!==5){showMsg('PIN must be 5 digits','error');return;}
  const user=state.users[pendingStockOut.staff];
  if(!user||user.password!==pin){showMsg('Wrong PIN','error');openInlinePin();return;}
  adjustStock(pendingStockOut.itemId,-pendingStockOut.qty,pendingStockOut.reason,pendingStockOut.staff,pin);
  showMsg('Stock issued successfully','success');cancelInlinePin();showDashboard();
}

/* ===== INIT ===== */
document.addEventListener('DOMContentLoaded', async ()=>{
  await loadState();await loadQueue();
  document.addEventListener('click',e=>{
    if(!e.target.matches('.key'))return;
    const key=e.target.dataset.key;
    if(!document.getElementById('loginScreen').classList.contains('hidden')){handleKeyPress(key);return;}
    if(document.getElementById('inlineKeypad')){
      const digits=document.querySelectorAll('#inlineKeypad .pin-digit');
      const filled=Array.from(digits).filter(d=>d.value).length;
      if(filled>=5)return;
      digits[filled].value=key;
      digits[filled].classList.add('filled');
      if(filled===4)confirmInlinePin();
    }
  });
  document.querySelectorAll('#loginScreen .pin-digit').forEach(d=>d.addEventListener('click',clearPin));
  updateSyncStatus();updateDash();renderAct();
});
</script>
</body>
</html>
